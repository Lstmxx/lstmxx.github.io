<!DOCTYPE html><html lang="cn" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>socketio实现服务器推送（demo实现一个聊天室） | Lstmxx的空间</title><meta name="author" content="Lstmxx"><meta name="copyright" content="Lstmxx"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="demo 演示地址：http:&#x2F;&#x2F;chat.lstmxx.cn github 地址：https:&#x2F;&#x2F;github.com&#x2F;Lstmxx&#x2F;chatroom 前言服务端推送是一种服务器主动给客户端发送的技术，主要用于实时对客户端进行消息推送，如天气预报、聊天功能等。 HTTP 1.x在 websocket api 出现之前，由于 http1.x 的缺陷，导致通信只能由客户端发起，用户想要获取到实时数据">
<meta property="og:type" content="article">
<meta property="og:title" content="socketio实现服务器推送（demo实现一个聊天室）">
<meta property="og:url" content="https://lstmxx.github.io/2020/06/29/socketio%E5%AE%9E%E7%8E%B0%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%8E%A8%E9%80%81%EF%BC%88demo%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E8%81%8A%E5%A4%A9%E5%AE%A4%EF%BC%89/index.html">
<meta property="og:site_name" content="Lstmxx的空间">
<meta property="og:description" content="demo 演示地址：http:&#x2F;&#x2F;chat.lstmxx.cn github 地址：https:&#x2F;&#x2F;github.com&#x2F;Lstmxx&#x2F;chatroom 前言服务端推送是一种服务器主动给客户端发送的技术，主要用于实时对客户端进行消息推送，如天气预报、聊天功能等。 HTTP 1.x在 websocket api 出现之前，由于 http1.x 的缺陷，导致通信只能由客户端发起，用户想要获取到实时数据">
<meta property="og:locale">
<meta property="og:image" content="https://avatars.githubusercontent.com/u/36261034?v=4">
<meta property="article:published_time" content="2020-06-29T03:20:26.000Z">
<meta property="article:modified_time" content="2023-09-23T03:40:32.475Z">
<meta property="article:author" content="Lstmxx">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://avatars.githubusercontent.com/u/36261034?v=4"><link rel="shortcut icon" href="https://avatars.githubusercontent.com/u/36261034?v=4"><link rel="canonical" href="https://lstmxx.github.io/2020/06/29/socketio%E5%AE%9E%E7%8E%B0%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%8E%A8%E9%80%81%EF%BC%88demo%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E8%81%8A%E5%A4%A9%E5%AE%A4%EF%BC%89/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Error',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'socketio实现服务器推送（demo实现一个聊天室）',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-09-23 11:40:32'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.2"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://avatars.githubusercontent.com/u/36261034?v=4" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">8</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">3</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">4</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa-fw fas fa-lines-leaning"></i><span> 文章</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/random/"><i class="fa-fw fas fa-random"></i><span> 随机</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/leetcode/"><i class="fa-fw fas fa-code"></i><span> leetcode</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.statically.io/gh/Lstmxx/picx-images-hosting@master/20230921/.4g1jf3ur1rc0.jpeg')"><nav id="nav"><span id="blog-info"><a href="/" title="Lstmxx的空间"><img class="site-icon" src="https://avatars.githubusercontent.com/u/36261034?v=4"/><span class="site-name">Lstmxx的空间</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa-fw fas fa-lines-leaning"></i><span> 文章</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/random/"><i class="fa-fw fas fa-random"></i><span> 随机</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/leetcode/"><i class="fa-fw fas fa-code"></i><span> leetcode</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">socketio实现服务器推送（demo实现一个聊天室）</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2020-06-29T03:20:26.000Z" title="Created 2020-06-29 11:20:26">2020-06-29</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2023-09-23T03:40:32.475Z" title="Updated 2023-09-23 11:40:32">2023-09-23</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="socketio实现服务器推送（demo实现一个聊天室）"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>demo 演示地址：<a target="_blank" rel="noopener" href="http://chat.lstmxx.cn/">http://chat.lstmxx.cn</a></p>
<p>github 地址：<a target="_blank" rel="noopener" href="https://github.com/Lstmxx/chatroom">https://github.com/Lstmxx/chatroom</a></p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>服务端推送是一种服务器主动给客户端发送的技术，主要用于实时对客户端进行消息推送，如天气预报、聊天功能等。</p>
<h3 id="HTTP-1-x"><a href="#HTTP-1-x" class="headerlink" title="HTTP 1.x"></a>HTTP 1.x</h3><p>在 websocket api 出现之前，由于 http1.x 的缺陷，导致通信只能由客户端发起，用户想要获取到实时数据变化，就要不停的向服务器发送请求，这种方法我们一般称为轮询。这种方法在 web 端可以一用，但是在移动端就不行了，想一想你的 app 不停的消耗你的流量发请求到服务器，这会导致用户流量的大量浪费，体现极其差。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">axios</span>()<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">    ···</span><br><span class="line">  &#125;).<span class="title function_">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">    ···</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;, <span class="number">3000</span>)</span><br></pre></td></tr></table></figure>

<h3 id="HTTP-2-0"><a href="#HTTP-2-0" class="headerlink" title="HTTP 2.0"></a>HTTP 2.0</h3><p>为了解决这一问题，终于在 http2.0 协议里面增加了一个新特性——服务器推送。而 Html5 根据这一特性提供了一种在单个 TCP 连接上进行全双工通讯的协议——<a target="_blank" rel="noopener" href="https://www.runoob.com/html/html5-websocket.html">WebSocket</a>。</p>
<h3 id="Socketio"><a href="#Socketio" class="headerlink" title="Socketio"></a>Socketio</h3><h4 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h4><p>如果客户端想要使用 websocket 接受服务器推送的话，Socketio 是一个不错的选择。Socket.io 将 Websocket、轮询机制以及其它的实时通信方式（ajax 等）封装成了通用的接口，并且在服务端也实现了这些实时机制的相应代码。所以，使用 Socket.io 便不需要担心浏览器兼容问题。</p>
<h4 id="namespace-和-room"><a href="#namespace-和-room" class="headerlink" title="namespace 和 room"></a>namespace 和 room</h4><p>socketio 有两个重要的概念——namespace 和 room。两者关系是 namespace 包含 room。举个例子，你要通知北小区的 4 座的所有用户交管理费，你先找到了北小区（namespace）然后再找到 4 座（room），最后给 4 座里面的业主发送交管理费消息。</p>
<h2 id="Socketio-的安装与使用"><a href="#Socketio-的安装与使用" class="headerlink" title="Socketio 的安装与使用"></a>Socketio 的安装与使用</h2><h3 id="Vue-中使用-Socketio"><a href="#Vue-中使用-Socketio" class="headerlink" title="Vue 中使用 Socketio"></a>Vue 中使用 Socketio</h3><p>在 Vue 中有两种方式使用 Socketio</p>
<h4 id="直接使用官方包"><a href="#直接使用官方包" class="headerlink" title="直接使用官方包"></a>直接使用官方包</h4><p>下载</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install socket.io</span><br></pre></td></tr></table></figure>

<p>引入</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> io <span class="keyword">from</span> <span class="string">&#x27;socket.io-client&#x27;</span></span><br></pre></td></tr></table></figure>

<p>使用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这里的namespace和后端设置的namespace是一样的</span></span><br><span class="line"><span class="keyword">const</span> socket = io.<span class="title function_">connect</span>(<span class="string">`http://<span class="subst">$&#123;域名&#125;</span>/<span class="subst">$&#123;namespace&#125;</span>`</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// on函数是监听函数，接受两个参数，第一个是订阅名，第二个是接受订阅信息的回调</span></span><br><span class="line">socket.<span class="title function_">on</span>(<span class="string">&#x27;chatMessage&#x27;</span>, <span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(res)</span><br><span class="line">&#125;)</span><br><span class="line">socket.<span class="title function_">on</span>(<span class="string">&#x27;response&#x27;</span>, <span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(res)</span><br><span class="line">&#125;)</span><br><span class="line">socket.<span class="title function_">on</span>(<span class="string">&#x27;connect&#x27;</span>, <span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(res)</span><br><span class="line">&#125;)</span><br><span class="line">···</span><br><span class="line"><span class="comment">// emit是发送函数，第一个参数是后端的订阅名，第二个是数据，可以是任意类型</span></span><br><span class="line">socket.<span class="title function_">emit</span>(<span class="string">&#x27;user_input&#x27;</span>, <span class="string">&#x27;wdnmd&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="使用-VueSocketio"><a href="#使用-VueSocketio" class="headerlink" title="使用 VueSocketio"></a>使用 VueSocketio</h4><p>相较于 socket.io-client，VueSocketio 自带支持在 vuex 中使用，这使得多组件共用消息更加便利。npm 地址：<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/vue-socket.io">https://www.npmjs.com/package/vue-socket.io</a> 。</p>
<p>下载</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install vue-socket.io</span><br></pre></td></tr></table></figure>

<p>引入</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /fronted/src/main.js</span></span><br><span class="line"><span class="keyword">import</span> store <span class="keyword">from</span> <span class="string">&#x27;./store&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">VueSocketio</span> <span class="keyword">from</span> <span class="string">&#x27;vue-socket.io&#x27;</span></span><br><span class="line">···</span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">use</span>(<span class="keyword">new</span> <span class="title class_">VueSocketio</span>(&#123;</span><br><span class="line">  <span class="attr">debug</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">connection</span>: <span class="string">`/<span class="subst">$&#123;namespace&#125;</span>`</span>,</span><br><span class="line">  <span class="comment">/* 推荐使用vuex引入，方便多组件状态共享 */</span></span><br><span class="line">  <span class="attr">vuex</span>: &#123;</span><br><span class="line">    store,</span><br><span class="line">    <span class="attr">actionPrefix</span>: <span class="string">&#x27;SOCKET_&#x27;</span> <span class="comment">// 前缀，为了区分vuex文件中响应函数和普通函数</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;))</span><br></pre></td></tr></table></figure>

<p>单组件使用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在需要监听的vue引入</span></span><br><span class="line">···</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">sockets</span>: &#123;</span><br><span class="line">    <span class="attr">connect</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;socket connected&#x27;</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">received</span>: <span class="keyword">function</span> (<span class="params">res</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(res)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">···</span><br></pre></td></tr></table></figure>

<p>vuex 中使用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /store/module/room.js</span></span><br><span class="line">···</span><br><span class="line"><span class="comment">// responseData 为响应数据</span></span><br><span class="line">SOCKET_received (&#123; state, rootState, commit &#125;, responseData) &#123;</span><br><span class="line">  <span class="comment">// do something</span></span><br><span class="line">&#125;,</span><br><span class="line">SOCKET_join_one (&#123;&#125;, responseData) &#123;</span><br><span class="line">  <span class="comment">// do something</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="flask-中使用-Socketio"><a href="#flask-中使用-Socketio" class="headerlink" title="flask 中使用 Socketio"></a>flask 中使用 Socketio</h3><p>flask 中使用 socketio 主要用到 Flask-SocketIO 这个包，官网地址：<a target="_blank" rel="noopener" href="https://flask-socketio.readthedocs.io/en/latest/">https://flask-socketio.readthedocs.io/en/latest/</a> 。</p>
<p>下载</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install flask-socketio</span><br></pre></td></tr></table></figure>

<p>使用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">···</span><br><span class="line"><span class="comment"># /backend/blueprint/socketio.py</span></span><br><span class="line"><span class="keyword">from</span> flask_cors <span class="keyword">import</span> CORS <span class="comment"># 跨域</span></span><br><span class="line"><span class="keyword">from</span> flask_socketio <span class="keyword">import</span> SocketIO, emit, join_room, leave_room, close_room, rooms, disconnect</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化socketio</span></span><br><span class="line">socketio = SocketIO(app, cors_allowed_origins=<span class="string">&quot;*&quot;</span>)</span><br><span class="line"><span class="comment"># 第一个参数为事件名，第二个为namespace</span></span><br><span class="line"><span class="comment"># 通过监听namespace下的事件做出响应，这里的namespace和前面前端定义的namespace要相同</span></span><br><span class="line"><span class="comment"># message为请求参数</span></span><br><span class="line"><span class="meta">@socketio.on(<span class="params"><span class="string">&#x27;test_input&#x27;</span>, namespace=<span class="string">&#x27;/chatroom&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test_input</span>(<span class="params">message</span>):</span><br><span class="line">    <span class="comment"># do someting</span></span><br><span class="line">    socketio.emit(<span class="string">&#x27;test_received&#x27;</span>, <span class="string">&#x27;收到啦&#x27;</span>, namespace=<span class="string">&#x27;/chatroom&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>在 app.py 中引入</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /backend/app.py</span></span><br><span class="line"><span class="keyword">from</span> blueprint.socketio <span class="keyword">import</span> app, socketio, db</span><br><span class="line">···</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    ···</span><br><span class="line">    socketio.run(app, host=<span class="string">&quot;0.0.0.0&quot;</span>, port=<span class="number">4999</span>, debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<h3 id="nginx-配置"><a href="#nginx-配置" class="headerlink" title="nginx 配置"></a>nginx 配置</h3><p>既然是前后端分离，那当然要使用 nginx 啦~</p>
<p>配置 chatroom.conf</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">upstream</span> chat_frontend &#123;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">127.0.0.1:8181</span>; <span class="comment"># 前端工程运行的地址</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">upstream</span> chat_backend &#123;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">127.0.0.1:4999</span>; <span class="comment"># 后端工程运行的地址</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span>       <span class="number">80</span>; <span class="comment"># 监听端口</span></span><br><span class="line">    <span class="attribute">server_name</span>  www.chatroom.com; <span class="comment">#域名</span></span><br><span class="line">        <span class="section">location</span><span class="regexp"> ^~</span> /api &#123; <span class="comment"># 普通接口路由</span></span><br><span class="line">            <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> X-Forwarded-Server <span class="variable">$host</span>;</span><br><span class="line">            <span class="attribute">proxy_pass</span> http://chat_backend;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="section">location</span> /socket.io &#123; <span class="comment"># socketio的路由</span></span><br><span class="line">            <span class="attribute">proxy_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line">            <span class="attribute">proxy_buffering</span> <span class="literal">off</span>;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> Connection <span class="string">&quot;Upgrade&quot;</span>;</span><br><span class="line">            <span class="attribute">proxy_pass</span> http://chat_backend;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="section">location</span> / &#123; <span class="comment"># 前端路由</span></span><br><span class="line">            <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> X-Forwarded-Server <span class="variable">$host</span>;</span><br><span class="line">            <span class="attribute">proxy_pass</span> http://chat_frontend;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置 host</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">···</span><br><span class="line">127.0.0.1 www.chatroom.com</span><br></pre></td></tr></table></figure>

<h3 id="通信"><a href="#通信" class="headerlink" title="通信"></a>通信</h3><p>前面把 flask 和 vue 都配置好了，那么先测试一下。</p>
<p>整个流程非常简单，流程图如下：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/6/29/172fe93449800d38~tplv-t2oaga2asx-image.image"></p>
<h4 id="vue"><a href="#vue" class="headerlink" title="vue"></a>vue</h4><p>获取用户输入后，向目标事件发送数据。这里我自己实现了一个简陋的 rich-text，如果不追求效果直接用 input 标签就完事了。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /src/components/chat-room/message-box/message-box.vue</span></span><br><span class="line">···</span><br><span class="line">sendMessage (message) &#123;</span><br><span class="line">  <span class="comment">// 第一个参数为事件名，第二个参数为要发送的数据</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">$socket</span>.<span class="title function_">emit</span>(<span class="string">&#x27;test_input&#x27;</span>, message)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 vuex 中监听 received 事件获取服务器返回消息。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /src/store/module/room.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  ···</span><br><span class="line">  <span class="attr">actions</span>: &#123;</span><br><span class="line">    ···</span><br><span class="line">    SOCKET_test_received (&#123; state, rootState, commit &#125;, responseData) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(responseData)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="flask"><a href="#flask" class="headerlink" title="flask"></a>flask</h4><p>后端这边就非常简单了，增加一个消息回调函数就好了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_socketio <span class="keyword">import</span> SocketIO, emit</span><br><span class="line">socketio = SocketIO(app, cors_allowed_origins=<span class="string">&quot;*&quot;</span>)</span><br><span class="line">···</span><br><span class="line"><span class="meta">@socketio.on(<span class="params"><span class="string">&#x27;test_input&#x27;</span>, namespace=<span class="string">&#x27;/chatroom&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test_input</span>(<span class="params">message</span>):</span><br><span class="line">    <span class="comment"># do someting</span></span><br><span class="line">    socketio.emit(<span class="string">&#x27;test_received&#x27;</span>, <span class="string">&#x27;收到啦&#x27;</span>, namespace=<span class="string">&#x27;/chatroom&#x27;</span>)</span><br><span class="line">    <span class="comment"># 或者</span></span><br><span class="line">    <span class="comment"># emit(&#x27;test_received&#x27;, &#x27;收到啦&#x27;, namespace=&#x27;/chatroom&#x27;)</span></span><br></pre></td></tr></table></figure>

<p>要注意的是，这个 emit 没有指定某一个 room，所以会广播给在这个 namespace 下的所有人。</p>
<p>打开谷歌浏览器，效果如下：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/6/29/172fe94c8b5e4c45~tplv-t2oaga2asx-image.image"></p>
<h2 id="实现聊天室小-demo"><a href="#实现聊天室小-demo" class="headerlink" title="实现聊天室小 demo"></a>实现聊天室小 demo</h2><h3 id="构思"><a href="#构思" class="headerlink" title="构思"></a>构思</h3><p>一个简单的聊天室肯定会涉及到用户，房间和消息记录。</p>
<h3 id="实现登录页面"><a href="#实现登录页面" class="headerlink" title="实现登录页面"></a>实现登录页面</h3><p>首先解决一下用户，最核心的是登录。先建一个用户表。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `<span class="keyword">user</span>`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `<span class="keyword">user</span>`  (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `username` <span class="type">varchar</span>(<span class="number">64</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_0900_ai_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `password` <span class="type">varchar</span>(<span class="number">64</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_0900_ai_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `create_time` datetime(<span class="number">0</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `avatar_image` <span class="type">varchar</span>(<span class="number">64</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_0900_ai_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `room_id_set` longtext <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_0900_ai_ci COMMENT <span class="string">&#x27;每个用户所参加的房间&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  INDEX `ix_user_username`(`username`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB AUTO_INCREMENT <span class="operator">=</span> <span class="number">5</span> <span class="type">CHARACTER</span> <span class="keyword">SET</span> <span class="operator">=</span> utf8mb4 <span class="keyword">COLLATE</span> <span class="operator">=</span> utf8mb4_0900_ai_ci ROW_FORMAT <span class="operator">=</span> <span class="keyword">Dynamic</span>;</span><br></pre></td></tr></table></figure>

<p>封装一下登录接口，使用 vuex 保存登录状态。因为关闭页面后 vuex 会清掉 token 使用 cookie 来保存（axios 的封装就不说了，不是重点）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /fronted/src/libs/requestApi.js</span></span><br><span class="line">···</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">baseLogin</span> (config) &#123;</span><br><span class="line">  <span class="keyword">const</span> request = &#123;</span><br><span class="line">    <span class="attr">url</span>: config.<span class="property">url</span>,</span><br><span class="line">    <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">    <span class="attr">data</span>: config.<span class="property">data</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> service.<span class="title function_">request</span>(request)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /fronted/src/libs/request.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">login</span> (config) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">baseLogin</span>(config).<span class="title function_">then</span>(<span class="function">(<span class="params">response</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">resolve</span>(response.<span class="property">data</span>.<span class="property">data</span>)</span><br><span class="line">    &#125;).<span class="title function_">catch</span>(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">reject</span>(err)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>保存 token</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /fronted/src/libs/utility/token.js</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Cookies</span> <span class="keyword">from</span> <span class="string">&#x27;js-cookie&#x27;</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">TOKEN_KEY</span> = <span class="string">&#x27;token&#x27;</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">setToken</span> = (<span class="params">token</span>) =&gt; &#123;</span><br><span class="line">  <span class="title class_">Cookies</span>.<span class="title function_">set</span>(<span class="variable constant_">TOKEN_KEY</span>, token, &#123; <span class="attr">expires</span>: <span class="number">1</span> &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">getToken</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> token = <span class="title class_">Cookies</span>.<span class="title function_">get</span>(<span class="variable constant_">TOKEN_KEY</span>)</span><br><span class="line">  <span class="keyword">if</span> (token !== <span class="string">&#x27;null&#x27;</span>) <span class="keyword">return</span> token</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编写 vuex 的 user 模块</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /fronted/src/store/module/user.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; getToken, setToken &#125; <span class="keyword">from</span> <span class="string">&#x27;../../libs/utility/token&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; login, getUserInfo, logout &#125; <span class="keyword">from</span> <span class="string">&#x27;@/libs/request&#x27;</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">state</span>: &#123;</span><br><span class="line">    <span class="attr">token</span>: <span class="title function_">getToken</span>(),</span><br><span class="line">    <span class="attr">userName</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">userId</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">avatarImage</span>: <span class="literal">null</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">getters</span>: &#123;</span><br><span class="line">    getToken (state) &#123;</span><br><span class="line">      <span class="keyword">return</span> state.<span class="property">token</span></span><br><span class="line">    &#125;,</span><br><span class="line">    getUserName (state) &#123;</span><br><span class="line">      <span class="keyword">return</span> state.<span class="property">userName</span></span><br><span class="line">    &#125;,</span><br><span class="line">    getUserId (state) &#123;</span><br><span class="line">      <span class="keyword">return</span> state.<span class="property">userId</span></span><br><span class="line">    &#125;,</span><br><span class="line">    getAvatarImage (state) &#123;</span><br><span class="line">      <span class="keyword">return</span> state.<span class="property">avatarImage</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">mutations</span>: &#123;</span><br><span class="line">    setToken (state, token) &#123;</span><br><span class="line">      state.<span class="property">token</span> = token</span><br><span class="line">      <span class="title function_">setToken</span>(token)</span><br><span class="line">    &#125;,</span><br><span class="line">    setUserName (state, name) &#123;</span><br><span class="line">      state.<span class="property">userName</span> = name</span><br><span class="line">    &#125;,</span><br><span class="line">    setUserId (state, userId) &#123;</span><br><span class="line">      state.<span class="property">userId</span> = userId</span><br><span class="line">    &#125;,</span><br><span class="line">    setAvatarImage (state, avatarImage) &#123;</span><br><span class="line">      state.<span class="property">avatarImage</span> = avatarImage</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">actions</span>: &#123;</span><br><span class="line">    handleLogin (&#123; commit &#125;, config) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">login</span>(config).<span class="title function_">then</span>(<span class="function">(<span class="params">responseData</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="title function_">commit</span>(<span class="string">&#x27;setToken&#x27;</span>, responseData.<span class="property">token</span>)</span><br><span class="line">          <span class="title function_">resolve</span>(responseData)</span><br><span class="line">        &#125;).<span class="title function_">catch</span>(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="title function_">reject</span>(err)</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(err)</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    loadUserInfo (&#123; commit &#125;) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">getUserInfo</span>().<span class="title function_">then</span>(<span class="function">(<span class="params">responseData</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="title function_">commit</span>(<span class="string">&#x27;setToken&#x27;</span>, <span class="title function_">getToken</span>())</span><br><span class="line">          <span class="title function_">commit</span>(<span class="string">&#x27;setUserName&#x27;</span>, responseData.<span class="property">userInfo</span>.<span class="property">name</span>)</span><br><span class="line">          <span class="title function_">commit</span>(<span class="string">&#x27;setUserId&#x27;</span>, responseData.<span class="property">userInfo</span>.<span class="property">userId</span>)</span><br><span class="line">          <span class="title function_">commit</span>(<span class="string">&#x27;setAvatarImage&#x27;</span>, responseData.<span class="property">userInfo</span>.<span class="property">avatar_image</span>)</span><br><span class="line">          <span class="title function_">resolve</span>(responseData)</span><br><span class="line">        &#125;).<span class="title function_">catch</span>(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="title function_">commit</span>(<span class="string">&#x27;setToken&#x27;</span>, <span class="literal">null</span>)</span><br><span class="line">          <span class="title function_">reject</span>(err)</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(err)</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 login 页面中使用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /fronted/src/views/login/login.vue</span></span><br><span class="line"><span class="keyword">import</span> &#123; mapActions &#125; <span class="keyword">from</span> <span class="string">&#x27;vuex&#x27;</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  ···</span><br><span class="line">  <span class="attr">methods</span>: &#123;</span><br><span class="line">    ...<span class="title function_">mapActions</span>([</span><br><span class="line">      <span class="string">&#x27;handleLogin&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;loadUserInfo&#x27;</span></span><br><span class="line">    ]),</span><br><span class="line">    checkCapslock (e) &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123; key &#125; = e</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">capsTooltip</span> = key &amp;&amp; key.<span class="property">length</span> === <span class="number">1</span> &amp;&amp; (key &gt;= <span class="string">&#x27;A&#x27;</span> &amp;&amp; key &lt;= <span class="string">&#x27;Z&#x27;</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 登录，成功后跳转</span></span><br><span class="line">    onLogin () &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">$refs</span>.<span class="property">loginForm</span>.<span class="title function_">validate</span>(<span class="function"><span class="params">valid</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (valid) &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">$Loading</span>.<span class="title function_">show</span>()</span><br><span class="line">          <span class="keyword">const</span> config = &#123;</span><br><span class="line">            <span class="attr">url</span>: <span class="string">&#x27;/login&#x27;</span>,</span><br><span class="line">            <span class="attr">data</span>: <span class="variable language_">this</span>.<span class="property">loginForm</span></span><br><span class="line">          &#125;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">handleLogin</span>(config).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">$Loading</span>.<span class="title function_">hide</span>()</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">$router</span>.<span class="title function_">push</span>(&#123;</span><br><span class="line">              <span class="attr">name</span>: <span class="string">&#x27;ChatRoom&#x27;</span></span><br><span class="line">            &#125;)</span><br><span class="line">          &#125;).<span class="title function_">catch</span>(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">$Loading</span>.<span class="title function_">hide</span>()</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(err)</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 注册，成功后回调登录</span></span><br><span class="line">    onRegister () &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">$refs</span>.<span class="property">loginForm</span>.<span class="title function_">validate</span>(<span class="function"><span class="params">valid</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (valid) &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">$Loading</span>.<span class="title function_">show</span>()</span><br><span class="line">          <span class="keyword">const</span> config = &#123;</span><br><span class="line">            <span class="attr">url</span>: <span class="string">&#x27;/register&#x27;</span>,</span><br><span class="line">            <span class="attr">data</span>: <span class="variable language_">this</span>.<span class="property">loginForm</span></span><br><span class="line">          &#125;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">handleLogin</span>(config).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">$Loading</span>.<span class="title function_">hide</span>()</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">onLogin</span>()</span><br><span class="line">          &#125;).<span class="title function_">catch</span>(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">$Loading</span>.<span class="title function_">hide</span>()</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(err)</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>后端方面，可以看看/backend/blueprint/user.py。ui 方面就不说了，不是重点。</p>
<h3 id="实现房间的创建，展示和加入功能"><a href="#实现房间的创建，展示和加入功能" class="headerlink" title="实现房间的创建，展示和加入功能"></a>实现房间的创建，展示和加入功能</h3><p>对于房间来说，肯定要有创建和加入这两个功能的，下面先说说创建。</p>
<p>先建个表吧</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `room`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `room`  (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `name` <span class="type">varchar</span>(<span class="number">64</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_0900_ai_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `owner` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;房间创建人&#x27;</span>,</span><br><span class="line">  `user_set` longtext <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_0900_ai_ci,</span><br><span class="line">  `description` longtext <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_0900_ai_ci,</span><br><span class="line">  `create_time` datetime(<span class="number">0</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `update_time` datetime(<span class="number">0</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `avatar_image` <span class="type">varchar</span>(<span class="number">64</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_0900_ai_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `room_hash_id` <span class="type">varchar</span>(<span class="number">32</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_0900_ai_ci <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  INDEX `ix_room_avatar_image`(`avatar_image`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  INDEX `ix_room_create_time`(`create_time`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  INDEX `ix_room_name`(`name`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  INDEX `ix_room_owner`(`owner`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  INDEX `ix_room_update_time`(`update_time`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  <span class="keyword">CONSTRAINT</span> `room_ibfk_1` <span class="keyword">FOREIGN</span> KEY (`owner`) <span class="keyword">REFERENCES</span> `<span class="keyword">user</span>` (`id`) <span class="keyword">ON</span> <span class="keyword">DELETE</span> RESTRICT <span class="keyword">ON</span> <span class="keyword">UPDATE</span> RESTRICT</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB AUTO_INCREMENT <span class="operator">=</span> <span class="number">38</span> <span class="type">CHARACTER</span> <span class="keyword">SET</span> <span class="operator">=</span> utf8mb4 <span class="keyword">COLLATE</span> <span class="operator">=</span> utf8mb4_0900_ai_ci ROW_FORMAT <span class="operator">=</span> <span class="keyword">Dynamic</span>;</span><br></pre></td></tr></table></figure>

<h4 id="创建房间"><a href="#创建房间" class="headerlink" title="创建房间"></a>创建房间</h4><p>首先先明确创建房间需要什么数据，我的想法是需要房间头像，房间名和房间描述。</p>
<p>前端主要是获取了房间头像、房间名和房间描述后发送请求到后端。这里的 upLoadFile 是自己模仿 element 来写的组件，有兴趣可以在 /fronted/src/components/base/up-load-file/up-load-file.vue 查看</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">// /fronted/src/components/chat-room/room-list/room-list.vue</span><br><span class="line">&lt;template&gt;</span><br><span class="line">···</span><br><span class="line">    &lt;el-dialog title=&quot;创建房间&quot; :visible.sync=&quot;createRoomDialog&quot;&gt;</span><br><span class="line">      &lt;el-form :model=&quot;createRoom&quot; :rules=&quot;createRules&quot; ref=&quot;createRoomForm&quot;&gt;</span><br><span class="line">        &lt;el-form-item label=&quot;房间名&quot; prop=&quot;hashId&quot;&gt;</span><br><span class="line">          &lt;el-input v-model=&quot;createRoom.name&quot; autocomplete=&quot;off&quot; :maxlength=&#x27;32&#x27; :minlength=&#x27;32&#x27;&gt;&lt;/el-input&gt;</span><br><span class="line">        &lt;/el-form-item&gt;</span><br><span class="line">        &lt;el-form-item label=&quot;房间描述&quot; prop=&quot;description&quot;&gt;</span><br><span class="line">          &lt;el-input v-model=&quot;createRoom.description&quot; autocomplete=&quot;off&quot; :maxlength=&#x27;32&#x27; :minlength=&#x27;32&#x27;&gt;&lt;/el-input&gt;</span><br><span class="line">        &lt;/el-form-item&gt;</span><br><span class="line">        &lt;el-form-item label=&quot;房间头像&quot; prop=&quot;avatarImage&quot;&gt;</span><br><span class="line">          &lt;upLoadFile :maxImageNum=&quot;1&quot; @on-change=&quot;getFilePath&quot;/&gt;</span><br><span class="line">        &lt;/el-form-item&gt;</span><br><span class="line">      &lt;/el-form&gt;</span><br><span class="line">      &lt;div slot=&quot;footer&quot; class=&quot;dialog-footer&quot;&gt;</span><br><span class="line">        &lt;el-button @click=&quot;createRoomDialog = false&quot;&gt;取 消&lt;/el-button&gt;</span><br><span class="line">        &lt;el-button type=&quot;primary&quot; @click=&quot;handleCreateRoom&quot;&gt;确 定&lt;/el-button&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &lt;/el-dialog&gt;</span><br><span class="line">···</span><br><span class="line">&lt;/template&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">import &#123; post &#125; from &#x27;@/libs/request&#x27;</span><br><span class="line">import upLoadFile from &#x27;@/components/base/up-load-file&#x27;</span><br><span class="line">export default &#123;</span><br><span class="line">  name: &#x27;RoomList&#x27;,</span><br><span class="line">  props: &#123;</span><br><span class="line">    roomList: &#123;</span><br><span class="line">      default: () =&gt; [],</span><br><span class="line">      type: Array</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  components: &#123;</span><br><span class="line">    ···</span><br><span class="line">    upLoadFile</span><br><span class="line">  &#125;,</span><br><span class="line">  data () &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">      ···</span><br><span class="line">      createRoom: &#123;</span><br><span class="line">        name: &#x27;&#x27;,</span><br><span class="line">        description: &#x27;&#x27;,</span><br><span class="line">        avatarImage: &#x27;&#x27;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  method: &#123;</span><br><span class="line">    getFilePath (imageList) &#123;</span><br><span class="line">      this.createRoom.avatarImage = imageList[0].base64Path</span><br><span class="line">    &#125;,</span><br><span class="line">    handleCreateRoom () &#123;</span><br><span class="line">      this.$refs.createRoomForm.validate(valid =&gt; &#123;</span><br><span class="line">        if (valid) &#123;</span><br><span class="line">          this.$Loading.show()</span><br><span class="line">          const config = &#123;</span><br><span class="line">            url: &#x27;/room/create&#x27;,</span><br><span class="line">            data: this.createRoom</span><br><span class="line">          &#125;</span><br><span class="line">          post(config).then((responseData) =&gt; &#123;</span><br><span class="line">            this.$Loading.hide()</span><br><span class="line">            this.createRoom.name = &#x27;&#x27;</span><br><span class="line">            this.createRoomDialog = false</span><br><span class="line">            this.createRoom = &#123;</span><br><span class="line">              name: &#x27;&#x27;,</span><br><span class="line">              description: &#x27;&#x27;,</span><br><span class="line">              avatarImage: &#x27;&#x27;</span><br><span class="line">            &#125;</span><br><span class="line">            this.$message(&#123;</span><br><span class="line">              message: &#x27;创建成功&#x27;,</span><br><span class="line">              type: &#x27;success&#x27;</span><br><span class="line">            &#125;)</span><br><span class="line">            this.$emit(&#x27;create-room-success&#x27;, responseData.room)</span><br><span class="line">          &#125;).catch((err) =&gt; &#123;</span><br><span class="line">            this.$Loading.hide()</span><br><span class="line">            this.createRoomDialog = false</span><br><span class="line">            console.log(err)</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>后端这边就简单了，直接插入数据库。插入时候使用 base64 来生成房间码，之后加入房间要用。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /backend/blueprint/room.py</span></span><br><span class="line">···</span><br><span class="line"><span class="meta">@room_bp.route(<span class="params"><span class="string">&#x27;/api/room/create&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="meta">@verify_token</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">room_create</span>(<span class="params">tokenData</span>):</span><br><span class="line">    values = request.get_json()</span><br><span class="line">    user = User.query.filter_by(<span class="built_in">id</span>=tokenData[<span class="string">&#x27;userId&#x27;</span>]).first()</span><br><span class="line">    <span class="keyword">if</span> user:</span><br><span class="line">        room = Room(name=values[<span class="string">&#x27;name&#x27;</span>],</span><br><span class="line">                    description=values[<span class="string">&#x27;description&#x27;</span>],</span><br><span class="line">                    user_set=<span class="built_in">str</span>(tokenData[<span class="string">&#x27;userId&#x27;</span>]),</span><br><span class="line">                    owner=user.<span class="built_in">id</span>,</span><br><span class="line">                    avatar_image=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        db.session.add(room)</span><br><span class="line">        db.session.flush()</span><br><span class="line">        room.room_hash_id = hashlib.md5(<span class="string">f&#x27;<span class="subst">&#123;room.<span class="built_in">id</span>&#125;</span><span class="subst">&#123;time.time()&#125;</span>&#x27;</span>.encode(<span class="string">&#x27;utf-8&#x27;</span>)).hexdigest()</span><br><span class="line">        room.user_set = <span class="string">f&#x27;<span class="subst">&#123;room.user_set&#125;</span>,<span class="subst">&#123;user.<span class="built_in">id</span>&#125;</span>&#x27;</span> <span class="keyword">if</span> room.user_set <span class="keyword">else</span> user.<span class="built_in">id</span></span><br><span class="line">        <span class="keyword">if</span> values[<span class="string">&#x27;avatarImage&#x27;</span>]:</span><br><span class="line">            avatartImageList = values[<span class="string">&#x27;avatarImage&#x27;</span>].split(<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">            suffix = avatartImageList[<span class="number">0</span>].split(<span class="string">&#x27;/&#x27;</span>)[<span class="number">1</span>].split(<span class="string">&#x27;;&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">            filename = <span class="string">f&#x27;room_avatar/<span class="subst">&#123;room.room_hash_id&#125;</span>.<span class="subst">&#123;suffix&#125;</span>&#x27;</span></span><br><span class="line">            <span class="built_in">print</span>(filename)</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">f&#x27;media/<span class="subst">&#123;filename&#125;</span>&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                f.write(base64.b64decode(avatartImageList[<span class="number">1</span>]))</span><br><span class="line">            room.avatar_image = filename</span><br><span class="line">        user.room_id_set = <span class="string">f&#x27;<span class="subst">&#123;user.room_id_set&#125;</span>,<span class="subst">&#123;room.<span class="built_in">id</span>&#125;</span>&#x27;</span> <span class="keyword">if</span> user.room_id_set <span class="keyword">else</span> room.<span class="built_in">id</span></span><br><span class="line">        db.session.commit()</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">            <span class="string">&#x27;data&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;room&#x27;</span>: JSONHelper.model_to_json(room)</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;成功&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;status&#x27;</span>: <span class="number">200</span></span><br><span class="line">        &#125;)</span><br><span class="line">    <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">        <span class="string">&#x27;data&#x27;</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;失败失败&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;status&#x27;</span>: <span class="number">500</span></span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>

<h4 id="展示房间"><a href="#展示房间" class="headerlink" title="展示房间"></a>展示房间</h4><p>这个其实就是拉一个房间列表。要注意的是前端获取到房间列表后，要调用 join_all 这个事件监听这些房间的消息。</p>
<p>后端</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@room_bp.route(<span class="params"><span class="string">&#x27;/api/room/list&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="meta">@verify_token</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">room_list</span>(<span class="params">tokenData</span>):</span><br><span class="line">    user = User.query.filter_by(<span class="built_in">id</span>=tokenData[<span class="string">&#x27;userId&#x27;</span>]).first()</span><br><span class="line">    <span class="keyword">if</span> user:</span><br><span class="line">        roomlist = Room.query.<span class="built_in">filter</span>(Room.<span class="built_in">id</span>.in_(user.room_id_set.split(<span class="string">&#x27;,&#x27;</span>))).<span class="built_in">all</span>() <span class="keyword">if</span> user.room_id_set <span class="keyword">else</span> []</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">            <span class="string">&#x27;data&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;roomList&#x27;</span>: JSONHelper.to_json_list(roomlist)</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;成功&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;status&#x27;</span>: <span class="number">200</span></span><br><span class="line">        &#125;)</span><br><span class="line">    <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">        <span class="string">&#x27;data&#x27;</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;失败失败&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;status&#x27;</span>: <span class="number">500</span></span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>

<p>前端这边先在 room 模块里编写加载房间列表函数。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /fronted/src/store/module/room.js</span></span><br><span class="line">···</span><br><span class="line">loadRoomList (&#123; commit &#125;) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> config = &#123;</span><br><span class="line">      <span class="attr">url</span>: <span class="string">&#x27;/room/list&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">get</span>(config).<span class="title function_">then</span>(<span class="function">(<span class="params">responseData</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">commit</span>(<span class="string">&#x27;setRoomList&#x27;</span>, responseData.<span class="property">roomList</span>)</span><br><span class="line">      <span class="title function_">resolve</span>(responseData.<span class="property">roomList</span>)</span><br><span class="line">    &#125;).<span class="title function_">catch</span>(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">reject</span>(err)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 chat-room 页面调用。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /fronted/src/views/chat-room/chat-room.vue</span></span><br><span class="line">mounted () &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">loadRoomList</span>().<span class="title function_">then</span>(<span class="function">(<span class="params">roomList</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> request = &#123;</span><br><span class="line">      <span class="attr">roomList</span>: roomList.<span class="title function_">map</span>(<span class="function"><span class="params">room</span> =&gt;</span> room.<span class="property">id</span>),</span><br><span class="line">      <span class="attr">userId</span>: <span class="variable language_">this</span>.<span class="property">userId</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">$socket</span>.<span class="title function_">emit</span>(<span class="string">&#x27;join_all&#x27;</span>, request)</span><br><span class="line">  &#125;).<span class="title function_">catch</span>(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(err)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>后端响应 join_all 事件，调用 join_room 加入用户所在的所有房间。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /backend/blueprint/socketio.py</span></span><br><span class="line"><span class="meta">@socketio.on(<span class="params"><span class="string">&#x27;join_all&#x27;</span>, namespace=<span class="string">&#x27;/chatroom&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">join_chats</span>(<span class="params">message</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;加入多个聊天室</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    user = User.query.filter_by(<span class="built_in">id</span>=message[<span class="string">&#x27;userId&#x27;</span>]).first()</span><br><span class="line">    <span class="keyword">if</span> user <span class="keyword">and</span> <span class="built_in">len</span>(message[<span class="string">&#x27;roomList&#x27;</span>]) &gt; <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">for</span> roomId <span class="keyword">in</span> message[<span class="string">&#x27;roomList&#x27;</span>]:</span><br><span class="line">            join_room(roomId)</span><br><span class="line">            emit(<span class="string">&#x27;received&#x27;</span>, &#123; <span class="comment"># 发送加入消息</span></span><br><span class="line">                <span class="string">&#x27;user&#x27;</span>: &#123;</span><br><span class="line">                    <span class="string">&#x27;id&#x27;</span>: user.<span class="built_in">id</span>,</span><br><span class="line">                    <span class="string">&#x27;name&#x27;</span>: user.username,</span><br><span class="line">                    <span class="string">&#x27;avatarImage&#x27;</span>: user.avatar_image,</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">&#x27;roomId&#x27;</span>: roomId,</span><br><span class="line">                <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;join&#x27;</span></span><br><span class="line">            &#125;, namespace=<span class="string">&#x27;/chatroom&#x27;</span>, room=roomId)</span><br></pre></td></tr></table></figure>

<h4 id="加入房间"><a href="#加入房间" class="headerlink" title="加入房间"></a>加入房间</h4><p>获取对应的房间码后，输入加入就 OK 了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">// /fronted/src/components/chat-room/room-list/room-list.vue</span><br><span class="line">&lt;template&gt;</span><br><span class="line">···</span><br><span class="line">    &lt;el-dialog title=&quot;加入房间&quot; :visible.sync=&quot;joinRoomDialog&quot;&gt;</span><br><span class="line">      &lt;el-form :model=&quot;joinRoom&quot; :rules=&quot;joinRules&quot; ref=&quot;joinRoomForm&quot;&gt;</span><br><span class="line">        &lt;el-form-item label=&quot;房间号&quot; prop=&quot;hashId&quot;&gt;</span><br><span class="line">          &lt;el-input v-model=&quot;joinRoom.hashId&quot; autocomplete=&quot;off&quot; :maxlength=&#x27;32&#x27; :minlength=&#x27;32&#x27;&gt;&lt;/el-input&gt;</span><br><span class="line">        &lt;/el-form-item&gt;</span><br><span class="line">      &lt;/el-form&gt;</span><br><span class="line">      &lt;div slot=&quot;footer&quot; class=&quot;dialog-footer&quot;&gt;</span><br><span class="line">        &lt;el-button @click=&quot;joinRoomDialog = false&quot;&gt;取 消&lt;/el-button&gt;</span><br><span class="line">        &lt;el-button type=&quot;primary&quot; @click=&quot;handleJoinRoom&quot;&gt;确 定&lt;/el-button&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &lt;/el-dialog&gt;</span><br><span class="line">···</span><br><span class="line">&lt;/template&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">import &#123; post &#125; from &#x27;@/libs/request&#x27;</span><br><span class="line">export default &#123;</span><br><span class="line">  name: &#x27;RoomList&#x27;,</span><br><span class="line">  props: &#123;</span><br><span class="line">    roomList: &#123;</span><br><span class="line">      default: () =&gt; [],</span><br><span class="line">      type: Array</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  data () &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">      ···</span><br><span class="line">      joinRoom: &#123;</span><br><span class="line">        hashId: &#x27;&#x27;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  method: &#123;</span><br><span class="line">    handleJoinRoom () &#123;</span><br><span class="line">      this.$refs.joinRoomForm.validate(valid =&gt; &#123;</span><br><span class="line">        if (valid) &#123;</span><br><span class="line">          this.$Loading.show()</span><br><span class="line">          const config = &#123;</span><br><span class="line">            url: &#x27;/room/join&#x27;,</span><br><span class="line">            data: &#123;</span><br><span class="line">              roomIdHash: this.joinRoom.hashId</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          post(config).then((responseData) =&gt; &#123;</span><br><span class="line">            this.$Loading.hide()</span><br><span class="line">            this.joinRoomDialog = false</span><br><span class="line">            this.$message(&#123;</span><br><span class="line">              message: &#x27;加入成功&#x27;,</span><br><span class="line">              type: &#x27;success&#x27;</span><br><span class="line">            &#125;)</span><br><span class="line">            this.$emit(&#x27;create-room-success&#x27;, responseData.room)</span><br><span class="line">          &#125;).catch((err) =&gt; &#123;</span><br><span class="line">            this.$Loading.hide()</span><br><span class="line">            console.log(err)</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>加入成功后，和创建一样，调用 join_one_chat 事件来加入房间。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /fronted/src/views/chat-room/chat-room.vue</span></span><br><span class="line">handleCreateJoinRoom (room) &#123;</span><br><span class="line">  <span class="keyword">const</span> roomList = <span class="variable language_">this</span>.<span class="property">roomList</span></span><br><span class="line">  roomList.<span class="title function_">push</span>(room)</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">$store</span>.<span class="title function_">commit</span>(<span class="string">&#x27;setRoomList&#x27;</span>, roomList)</span><br><span class="line">  <span class="keyword">const</span> request = &#123;</span><br><span class="line">    <span class="attr">roomId</span>: room.<span class="property">id</span>,</span><br><span class="line">    <span class="attr">userId</span>: <span class="variable language_">this</span>.<span class="property">userId</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">$socket</span>.<span class="title function_">emit</span>(<span class="string">&#x27;join_one_chat&#x27;</span>, request)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>后端响应回调。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /backend/blueprint/socketio.py</span></span><br><span class="line"><span class="meta">@socketio.on(<span class="params"><span class="string">&#x27;join_one_chat&#x27;</span>, namespace=<span class="string">&#x27;/chatroom&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">join_one_chat</span>(<span class="params">join</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;加入聊天室</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    room = Room.query.filter_by(<span class="built_in">id</span>=join[<span class="string">&#x27;roomId&#x27;</span>]).first()</span><br><span class="line">    user = User.query.filter_by(<span class="built_in">id</span>=join[<span class="string">&#x27;userId&#x27;</span>]).first()</span><br><span class="line">    <span class="built_in">print</span>(join)</span><br><span class="line">    <span class="keyword">if</span> room <span class="keyword">and</span> user:</span><br><span class="line">        join_room(room.<span class="built_in">id</span>)</span><br><span class="line">        emit(<span class="string">&#x27;received&#x27;</span>, &#123;</span><br><span class="line">            <span class="string">&#x27;user&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;id&#x27;</span>: user.<span class="built_in">id</span>,</span><br><span class="line">                <span class="string">&#x27;name&#x27;</span>: user.username,</span><br><span class="line">                <span class="string">&#x27;avatarImage&#x27;</span>: user.avatar_image,</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&#x27;roomId&#x27;</span>: room.<span class="built_in">id</span>,</span><br><span class="line">            <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;join&#x27;</span></span><br><span class="line">        &#125;, namespace=<span class="string">&#x27;/chatroom&#x27;</span>, room=room)</span><br></pre></td></tr></table></figure>

<h3 id="消息记录的发送与保存"><a href="#消息记录的发送与保存" class="headerlink" title="消息记录的发送与保存"></a>消息记录的发送与保存</h3><p>先建个表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> NAMES utf8mb4;</span><br><span class="line"><span class="keyword">SET</span> FOREIGN_KEY_CHECKS <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-----------------------------</span></span><br><span class="line"><span class="operator">-</span><span class="keyword">Table</span> structure <span class="keyword">for</span> room_record</span><br><span class="line"><span class="comment">-----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `room_record`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `room_record`  (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `content` longtext <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_0900_ai_ci,</span><br><span class="line">  `create_time` datetime(<span class="number">0</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `room_id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `user_id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  INDEX `ix_room_record_create_time`(`create_time`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  INDEX `ix_room_record_room_id`(`room_id`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  <span class="keyword">CONSTRAINT</span> `room_record_ibfk_1` <span class="keyword">FOREIGN</span> KEY (`room_id`) <span class="keyword">REFERENCES</span> `room` (`id`) <span class="keyword">ON</span> <span class="keyword">DELETE</span> RESTRICT <span class="keyword">ON</span> <span class="keyword">UPDATE</span> RESTRICT</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB AUTO_INCREMENT <span class="operator">=</span> <span class="number">12</span> <span class="type">CHARACTER</span> <span class="keyword">SET</span> <span class="operator">=</span> utf8mb4 <span class="keyword">COLLATE</span> <span class="operator">=</span> utf8mb4_0900_ai_ci ROW_FORMAT <span class="operator">=</span> <span class="keyword">Dynamic</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span> FOREIGN_KEY_CHECKS <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>用户选择了对应房间，在对应房间中发送消息就 OK 了。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /fronted/src/components/chat-room/message-box/message-box.vue</span></span><br><span class="line">···</span><br><span class="line"><span class="keyword">import</span> &#123; mapGetters, mapActions &#125; <span class="keyword">from</span> <span class="string">&#x27;vuex&#x27;</span></span><br><span class="line"><span class="keyword">import</span> util <span class="keyword">from</span> <span class="string">&#x27;@/libs/utility/util.js&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">UserMessage</span> <span class="keyword">from</span> <span class="string">&#x27;../user-message/index&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">JoinMessage</span> <span class="keyword">from</span> <span class="string">&#x27;../join-message/index&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">RichText</span> <span class="keyword">from</span> <span class="string">&#x27;@/components/base/rich-text/index&#x27;</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;MessageBox&#x27;</span>,</span><br><span class="line">  <span class="attr">components</span>: &#123;</span><br><span class="line">    <span class="title class_">UserMessage</span>,</span><br><span class="line">    <span class="title class_">JoinMessage</span>,</span><br><span class="line">    <span class="title class_">RichText</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">computed</span>: &#123;</span><br><span class="line">    ...<span class="title function_">mapGetters</span>(&#123;</span><br><span class="line">      <span class="attr">selectedRoom</span>: <span class="string">&#x27;getSelectedRoom&#x27;</span>,</span><br><span class="line">      <span class="attr">userId</span>: <span class="string">&#x27;getUserId&#x27;</span>,</span><br><span class="line">      <span class="attr">userName</span>: <span class="string">&#x27;getUserName&#x27;</span>,</span><br><span class="line">      <span class="attr">messageList</span>: <span class="string">&#x27;getMessageList&#x27;</span>,</span><br><span class="line">      <span class="attr">isUpdate</span>: <span class="string">&#x27;getUpdate&#x27;</span>,</span><br><span class="line">      <span class="attr">avatarImage</span>: <span class="string">&#x27;getAvatarImage&#x27;</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">watch</span>: &#123;</span><br><span class="line">    selectedRoom () &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">setMessageContentScroll</span>()</span><br><span class="line">    &#125;,</span><br><span class="line">    isUpdate () &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">isUpdate</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.$forceUpdate()</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">updateComplete</span>()</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">setMessageContentScroll</span>()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">methods</span>: &#123;</span><br><span class="line">    ...<span class="title function_">mapActions</span>([</span><br><span class="line">      <span class="string">&#x27;updateComplete&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;userInput&#x27;</span></span><br><span class="line">    ]),</span><br><span class="line">    setMessageContentScroll () &#123;</span><br><span class="line">      <span class="variable language_">this</span>.$nextTick(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> messageContent = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;messageContent&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> (messageContent) &#123;</span><br><span class="line">          <span class="keyword">if</span> (messageContent.<span class="property">scrollHeight</span> &gt; messageContent.<span class="property">clientHeight</span>) &#123;</span><br><span class="line">            messageContent.<span class="property">scrollTop</span> = messageContent.<span class="property">scrollHeight</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    sendMessage (message) &#123;</span><br><span class="line">      <span class="keyword">const</span> messageId = <span class="title class_">Number</span>(<span class="keyword">new</span> <span class="title class_">Date</span>())</span><br><span class="line">      <span class="keyword">const</span> messageContext = &#123;</span><br><span class="line">        <span class="attr">user</span>: &#123;</span><br><span class="line">          <span class="attr">id</span>: <span class="variable language_">this</span>.<span class="property">userId</span>,</span><br><span class="line">          <span class="attr">name</span>: <span class="variable language_">this</span>.<span class="property">userName</span>,</span><br><span class="line">          <span class="attr">avatarImage</span>: <span class="variable language_">this</span>.<span class="property">avatarImage</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">roomId</span>: <span class="variable language_">this</span>.<span class="property">selectedRoom</span>.<span class="property">id</span>,</span><br><span class="line">        <span class="attr">id</span>: messageId,</span><br><span class="line">        message,</span><br><span class="line">        <span class="attr">loading</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;input&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">const</span> request = &#123;</span><br><span class="line">        <span class="attr">userId</span>: <span class="variable language_">this</span>.<span class="property">userId</span>,</span><br><span class="line">        <span class="attr">roomId</span>: <span class="variable language_">this</span>.<span class="property">selectedRoom</span>.<span class="property">id</span>,</span><br><span class="line">        <span class="attr">id</span>: messageId,</span><br><span class="line">        message,</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;input&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">userInput</span>(messageContext)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">$socket</span>.<span class="title function_">emit</span>(<span class="string">&#x27;user_send_message&#x27;</span>, request)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>后端。接收到请求后，完成插入数据库处理并通过 received 事件返回给前端</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /backend/blueprint/socketio.py</span></span><br><span class="line"><span class="meta">@socketio.on(<span class="params"><span class="string">&#x27;user_send_message&#x27;</span>, namespace=<span class="string">&#x27;/chatroom&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">user_input</span>(<span class="params">message</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;获取用户输入</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    userId = message[<span class="string">&#x27;userId&#x27;</span>]</span><br><span class="line">    user = User.query.filter_by(<span class="built_in">id</span>=message[<span class="string">&#x27;userId&#x27;</span>]).first()</span><br><span class="line">    <span class="keyword">if</span> user:</span><br><span class="line">        response = &#123;</span><br><span class="line">            <span class="string">&#x27;user&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;id&#x27;</span>: user.<span class="built_in">id</span>,</span><br><span class="line">                <span class="string">&#x27;name&#x27;</span>: user.username,</span><br><span class="line">                <span class="string">&#x27;avatarImage&#x27;</span>: user.avatar_image,</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&#x27;message&#x27;</span>: message[<span class="string">&#x27;message&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;roomId&#x27;</span>: message[<span class="string">&#x27;roomId&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;id&#x27;</span>: message[<span class="string">&#x27;id&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;type&#x27;</span>: message[<span class="string">&#x27;type&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;time&#x27;</span>: datetime.utcnow().isoformat(),</span><br><span class="line">        &#125;</span><br><span class="line">        roomRecord = RoomRecord(content=message[<span class="string">&#x27;message&#x27;</span>], user_id=user.<span class="built_in">id</span>, room_id=message[<span class="string">&#x27;roomId&#x27;</span>])</span><br><span class="line">        db.session.add(roomRecord)</span><br><span class="line">        db.session.commit()</span><br><span class="line">        socketio.emit(<span class="string">&#x27;received&#x27;</span>, response,</span><br><span class="line">                        namespace=<span class="string">&#x27;/chatroom&#x27;</span>,</span><br><span class="line">                        room=message[<span class="string">&#x27;roomId&#x27;</span>])</span><br></pre></td></tr></table></figure>

<p>前端 vuex 的 room 模块接收</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /fronted/src/store/module/room.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">action</span>: &#123;</span><br><span class="line">    updateComplete (&#123; commit &#125;) &#123;</span><br><span class="line">      <span class="title function_">commit</span>(<span class="string">&#x27;setUpdate&#x27;</span>, <span class="literal">false</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    SOCKET_received (&#123; state, rootState, commit &#125;, responseData) &#123;</span><br><span class="line">      <span class="keyword">const</span> messageList = state.<span class="property">messageList</span></span><br><span class="line">      <span class="keyword">const</span> user = rootState.<span class="property">user</span></span><br><span class="line">      responseData.<span class="property">time</span> = <span class="title function_">normalizeTimeDetail</span>(responseData.<span class="property">time</span>)</span><br><span class="line">      <span class="keyword">if</span> (user.<span class="property">userId</span> === responseData.<span class="property">user</span>.<span class="property">id</span> &amp;&amp; responseData.<span class="property">type</span> !== <span class="string">&#x27;join&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = messageList[responseData.<span class="property">roomId</span>].<span class="property">length</span> <span class="number">1</span>; i &gt; <span class="number">0</span>; i--) &#123;</span><br><span class="line">          <span class="keyword">if</span> (messageList[responseData.<span class="property">roomId</span>][i].<span class="property">user</span>.<span class="property">id</span> === user.<span class="property">userId</span> &amp;&amp; responseData.<span class="property">id</span> === messageList[responseData.<span class="property">roomId</span>][i].<span class="property">id</span>) &#123;</span><br><span class="line">            messageList[responseData.<span class="property">roomId</span>][i].<span class="property">loading</span> = <span class="literal">false</span></span><br><span class="line">            messageList[responseData.<span class="property">roomId</span>][i].<span class="property">time</span> = responseData.<span class="property">time</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!state.<span class="property">update</span>) &#123;</span><br><span class="line">          <span class="title function_">commit</span>(<span class="string">&#x27;setUpdate&#x27;</span>, <span class="literal">true</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!messageList[responseData.<span class="property">roomId</span>]) &#123;</span><br><span class="line">          messageList[responseData.<span class="property">roomId</span>] = []</span><br><span class="line">        &#125;</span><br><span class="line">        messageList[responseData.<span class="property">roomId</span>].<span class="title function_">push</span>(responseData)</span><br><span class="line">        <span class="keyword">if</span> (!state.<span class="property">update</span>) &#123;</span><br><span class="line">          <span class="title function_">commit</span>(<span class="string">&#x27;setUpdate&#x27;</span>, state.<span class="property">selectedRoom</span> ? responseData.<span class="property">roomId</span> === state.<span class="property">selectedRoom</span>.<span class="property">id</span> : <span class="literal">false</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="title function_">commit</span>(<span class="string">&#x27;setMessageList&#x27;</span>, messageList)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>说到这里其实也说完了重点的地方了，有兴趣可以看看源码。第一次写文章，有不足的地方请大佬们多多指点。</p>
<h2 id="参考连接"><a href="#参考连接" class="headerlink" title="参考连接"></a>参考连接</h2><ul>
<li>[1] <a target="_blank" rel="noopener" href="https://www.runoob.com/html/html5-websocket.html">https://www.runoob.com/html/html5-websocket.html</a></li>
<li>[2] <a target="_blank" rel="noopener" href="https://www.npmjs.com/package/vue-socket.io">https://www.npmjs.com/package/vue-socket.io</a></li>
<li>[3] <a target="_blank" rel="noopener" href="https://flask-socketio.readthedocs.io/en/latest/">https://flask-socketio.readthedocs.io/en/latest/</a></li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="https://lstmxx.github.io">Lstmxx</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://lstmxx.github.io/2020/06/29/socketio%E5%AE%9E%E7%8E%B0%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%8E%A8%E9%80%81%EF%BC%88demo%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E8%81%8A%E5%A4%A9%E5%AE%A4%EF%BC%89/">https://lstmxx.github.io/2020/06/29/socketio%E5%AE%9E%E7%8E%B0%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%8E%A8%E9%80%81%EF%BC%88demo%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E8%81%8A%E5%A4%A9%E5%AE%A4%EF%BC%89/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://avatars.githubusercontent.com/u/36261034?v=4" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-full"><a href="/2023/11/07/nestjs%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" title="nestjs环境搭建"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">Previous</div><div class="prev_info">nestjs环境搭建</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://avatars.githubusercontent.com/u/36261034?v=4" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Lstmxx</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">8</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">3</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">4</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Lstmxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/Lstmxx" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:740719284@qq.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">emmmmmm</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#HTTP-1-x"><span class="toc-number">1.1.</span> <span class="toc-text">HTTP 1.x</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HTTP-2-0"><span class="toc-number">1.2.</span> <span class="toc-text">HTTP 2.0</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Socketio"><span class="toc-number">1.3.</span> <span class="toc-text">Socketio</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8F%8F%E8%BF%B0"><span class="toc-number">1.3.1.</span> <span class="toc-text">描述</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#namespace-%E5%92%8C-room"><span class="toc-number">1.3.2.</span> <span class="toc-text">namespace 和 room</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Socketio-%E7%9A%84%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8"><span class="toc-number">2.</span> <span class="toc-text">Socketio 的安装与使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Vue-%E4%B8%AD%E4%BD%BF%E7%94%A8-Socketio"><span class="toc-number">2.1.</span> <span class="toc-text">Vue 中使用 Socketio</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%B4%E6%8E%A5%E4%BD%BF%E7%94%A8%E5%AE%98%E6%96%B9%E5%8C%85"><span class="toc-number">2.1.1.</span> <span class="toc-text">直接使用官方包</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-VueSocketio"><span class="toc-number">2.1.2.</span> <span class="toc-text">使用 VueSocketio</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#flask-%E4%B8%AD%E4%BD%BF%E7%94%A8-Socketio"><span class="toc-number">2.2.</span> <span class="toc-text">flask 中使用 Socketio</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#nginx-%E9%85%8D%E7%BD%AE"><span class="toc-number">2.3.</span> <span class="toc-text">nginx 配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E4%BF%A1"><span class="toc-number">2.4.</span> <span class="toc-text">通信</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#vue"><span class="toc-number">2.4.1.</span> <span class="toc-text">vue</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#flask"><span class="toc-number">2.4.2.</span> <span class="toc-text">flask</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E8%81%8A%E5%A4%A9%E5%AE%A4%E5%B0%8F-demo"><span class="toc-number">3.</span> <span class="toc-text">实现聊天室小 demo</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%84%E6%80%9D"><span class="toc-number">3.1.</span> <span class="toc-text">构思</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E7%99%BB%E5%BD%95%E9%A1%B5%E9%9D%A2"><span class="toc-number">3.2.</span> <span class="toc-text">实现登录页面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%88%BF%E9%97%B4%E7%9A%84%E5%88%9B%E5%BB%BA%EF%BC%8C%E5%B1%95%E7%A4%BA%E5%92%8C%E5%8A%A0%E5%85%A5%E5%8A%9F%E8%83%BD"><span class="toc-number">3.3.</span> <span class="toc-text">实现房间的创建，展示和加入功能</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%88%BF%E9%97%B4"><span class="toc-number">3.3.1.</span> <span class="toc-text">创建房间</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B1%95%E7%A4%BA%E6%88%BF%E9%97%B4"><span class="toc-number">3.3.2.</span> <span class="toc-text">展示房间</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%A0%E5%85%A5%E6%88%BF%E9%97%B4"><span class="toc-number">3.3.3.</span> <span class="toc-text">加入房间</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E8%AE%B0%E5%BD%95%E7%9A%84%E5%8F%91%E9%80%81%E4%B8%8E%E4%BF%9D%E5%AD%98"><span class="toc-number">3.4.</span> <span class="toc-text">消息记录的发送与保存</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">4.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%BF%9E%E6%8E%A5"><span class="toc-number">5.</span> <span class="toc-text">参考连接</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/10/18/%E5%9F%BA%E4%BA%8Ewebtorrent%E5%92%8Celectron%E7%9A%84%E7%A3%81%E5%8A%9B%E9%93%BE%E4%B8%8B%E8%BD%BD%E5%99%A8/" title="基于webtorrent和electron的磁力链下载器">基于webtorrent和electron的磁力链下载器</a><time datetime="2024-10-18T02:56:48.000Z" title="Created 2024-10-18 10:56:48">2024-10-18</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/10/18/%E5%A6%82%E4%BD%95%E7%BB%95%E5%BC%80%E6%B5%8F%E8%A7%88%E5%99%A8%E6%89%B9%E9%87%8F%E4%B8%8B%E8%BD%BD%E7%9A%84%E9%99%90%E5%88%B6/" title="如何绕开浏览器批量下载的限制">如何绕开浏览器批量下载的限制</a><time datetime="2024-10-18T02:53:09.000Z" title="Created 2024-10-18 10:53:09">2024-10-18</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/07/04/%E5%A6%82%E4%BD%95%E6%8B%86%E5%88%86long%20task/" title="如何拆分long task">如何拆分long task</a><time datetime="2024-07-04T03:36:59.000Z" title="Created 2024-07-04 11:36:59">2024-07-04</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/07/01/%E5%A6%82%E4%BD%95%E6%9E%84%E5%BB%BA%E6%A0%91%E5%BD%A2%E6%95%B0%E6%8D%AE%E5%92%8C%E5%B0%81%E8%A3%85%E6%A0%91%E5%BD%A2%E7%BB%84%E4%BB%B6/" title="如何构建树形数据和封装树形组件">如何构建树形数据和封装树形组件</a><time datetime="2024-07-01T08:43:24.000Z" title="Created 2024-07-01 16:43:24">2024-07-01</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/12/04/nestjs%E8%87%AA%E5%AE%9A%E4%B9%89filters%E5%92%8Clogger/" title="nestjs自定义filters和logger">nestjs自定义filters和logger</a><time datetime="2023-12-04T15:21:16.000Z" title="Created 2023-12-04 23:21:16">2023-12-04</time></div></div></div></div></div></div></main><footer id="footer" style="background: transparent"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By Lstmxx</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="Toggle Between Traditional Chinese And Simplified Chinese">繁</button><button id="darkmode" type="button" title="Toggle Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>